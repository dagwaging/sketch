<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="sketch-api">
  <template>
    <style>
      :host {
        display: none;
      }
    </style>
  <iframe id="frame" src='https://garyc.me/files/slide.php?max=2%27><script>`&filename=%27`;window.addEventListener("message",async e => { try { e.source.postMessage({ data: await fetch.apply(window, e.data.data).then(t => t.text()), success: true, id: e.data.id }, "*"); } catch (error) { e.source.postMessage({ data: error, success: false, id: e.data.id }, "*"); } })</script>'></iframe>
  </template>
  <script>
  (function() {
    var GET_STATS_INTERVAL = 10000;
    var GET_INTERVAL = 3000;

    Polymer({
      is: 'sketch-api',

      attached: function() {
        this.$.frame.addEventListener('load', () => {
          this._getStats();
          setInterval(this._getStats.bind(this), GET_STATS_INTERVAL);
        });
      },

      // Public properties

      properties: {
        loading: {
          type: Boolean,
          value: false,
          notify: true,
          readOnly: true
        },
        sketches: {
          type: Number,
          value: 0,
          notify: true,
          readOnly: true
        },
        artists: {
          type: Number,
          value: 0,
          notify: true,
          readOnly: true
        },
        peekers: {
          type: Number,
          value: 0,
          notify: true,
          readOnly: true
        }
      },

      // Public functions

      peek: function() {
        this._setLoading(true);
        this._request('https://garyc.me/sketch/get.php').then((data) => {
          this.fire('get', data);
          this._setLoading(false);
        });
      },

      swap: function(sketch) {
        this._setLoading(true);
        this._request(
          'https://garyc.me/sketch/swap.php?v=32',
          {
            method: 'post',
            body: sketch
          }
        ).then((data) => {
          let id = parseInt(data);

          if(id < 0) {
            setTimeout(() => this.swap(sketch), (1 - id) * 1000);
          }
          else {
            let listener = (data) => {
              if (data == 'wait') {
                setTimeout(() => this._request('https://garyc.me/sketch/get.php?id=' + id).then(listener), GET_INTERVAL);
              }
              else {
                this.fire('get', data);
                this._setLoading(false);
              }
            };

            this._request('https://garyc.me/sketch/get.php?id=' + id).then(listener);
          }
        });
      },

      save: function(data) {
        var a = document.createElement('a');
        a.setAttribute('download', 'sketch.png');
        a.href = data;
        a.click();
      },

      // Private functions

      _getStats: function() {
        this._request('https://garyc.me/sketch/getStats.php?timespan=300').then((data) => {
          let stats = data.split(",");
          this._setSketches(parseInt(stats[0]));
          this._setArtists(parseInt(stats[1]));
          this._setPeekers(parseInt(stats[2]));
        });
      },

      _request: async function(...request) {
        return new Promise((resolve, reject) => {
          let id = Math.random();

          let listener = (e) => {
            if (e.data.id == id) {
              window.removeEventListener('message', listener);
              if (e.data.success) {
                resolve(e.data.data);
              }
              else {
                reject(e.data.data);
              }
            }
          };

          window.addEventListener('message', listener);
          this.$.frame.contentWindow.postMessage({ data: request, id: id }, '*');
        });
      }
    });
  })();
  </script>
</dom-module>

